<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Benford Pro Max | AI è‡ªæˆ‘å„ªåŒ–ç‰ˆ</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
:root { --sidebar-width: 350px; --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; --danger: #ef4444; --success: #10b981; }
body, html { margin: 0; padding: 0; height: 100%; font-family: system-ui, -apple-system, sans-serif; background: var(--bg); overflow: hidden; }
.wrapper { display: flex; height: 100vh; }

/* Sidebar */
.sidebar { width: var(--sidebar-width); background: #1e293b; color: white; padding: 25px; box-sizing: border-box; overflow-y: auto; display: flex; flex-direction: column; }
.sidebar h2 { color: #38bdf8; border-bottom: 1px solid #334155; padding-bottom: 15px; margin-bottom: 20px; }

/* Main Content */
.main-content { flex: 1; padding: 30px; overflow-y: auto; box-sizing: border-box; position: relative; }

/* UI Elements */
.card { background: var(--card); border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
.upload-zone { border: 2px dashed #475569; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; margin-bottom: 20px; }
.control-group { margin-bottom: 20px; }
.tag { display: inline-block; padding: 6px 12px; border-radius: 6px; background: #334155; font-size: 0.85rem; cursor: pointer; margin: 2px; }
.tag.active { background: var(--primary); }
.toggle-box { background: #334155; padding: 12px; border-radius: 8px; margin-top: 8px; cursor: pointer; display: flex; justify-content: space-between; }

/* Stats */
.stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
.stat-item { padding: 15px; border-radius: 8px; background: #f1f5f9; text-align: center; }
.stat-val { font-size: 1.4rem; font-weight: 700; color: var(--primary); }

table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
th { background: #f1f5f9; padding: 12px; text-align: left; position: sticky; top: 0; }
td { padding: 10px; border-bottom: 1px solid #f1f5f9; }
.high-risk { background: #fef2f2; border-left: 4px solid var(--danger); }

.btn { border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
.btn-test { background: #475569; color: white; }
.btn-export { background: var(--success); color: white; }
.btn-clear { background: #ef4444; color: white; margin-top: 10px; }

/* Loading */
#loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); color: white; text-align: center; padding-top: 40vh; font-size: 1.2rem; z-index: 9999; }

.info-text { font-size: 0.8rem; color: #94a3b8; margin-bottom: 15px; }

/* å³ä¸Šè§’èªªæ˜æŒ‰éˆ• */
#help-btn {
position: absolute;
top: 20px;
right: 30px;
background: #64748b;
color: white;
border: none;
border-radius: 50%;
width: 44px;
height: 44px;
font-size: 1.2rem;
cursor: pointer;
box-shadow: 0 2px 8px rgba(0,0,0,0.2);
z-index: 100;
}

/* Modal */
.modal {
display: none;
position: fixed;
z-index: 1000;
left: 0;
top: 0;
width: 100%;
height: 100%;
background-color: rgba(0,0,0,0.6);
}
.modal-content {
background-color: #fff;
margin: 8% auto;
padding: 30px;
border-radius: 12px;
width: 80%;
max-width: 900px;
max-height: 80vh;
overflow-y: auto;
box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}
.close {
color: #aaa;
float: right;
font-size: 28px;
font-weight: bold;
cursor: pointer;
}
.close:hover { color: #000; }
.modal h2 { margin-top: 0; color: var(--primary); }
.modal h3 { color: #1e293b; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; }
</style>
</head>
<body>

<div class="wrapper">
<div class="sidebar">
<h2>Benford Pro Max</h2>

<div class="upload-zone" onclick="document.getElementById('fileInput').click()">
<span style="font-size: 1.5rem;">ğŸ“¥</span>
<p>ä¸Šå‚³æª”æ¡ˆ (Excel/CSV)</p>
<input type="file" id="fileInput" hidden accept=".xlsx, .xls, .csv">
</div>

<button class="btn btn-test" onclick="generateTestData()">ğŸ§ª ç”Ÿæˆ AI æ¨¡æ“¬æ¸¬è©¦æ•¸æ“š</button>

<div id="sheetSection" class="control-group" style="display:none; margin-top:20px;">
<span style="font-size: 0.8rem; color: #94a3b8;">é¸æ“‡ Excel å·¥ä½œè¡¨</span>
<div id="sheetList" style="margin-top:10px;"></div>
</div>

<div id="colSection" class="control-group" style="display:none; margin-top:20px;">
<span style="font-size: 0.8rem; color: #94a3b8;">é¸æ“‡åˆ†ææ¬„ä½</span>
<div id="columnList" style="margin-top:10px;"></div>
</div>

<div class="control-group" style="margin-top:20px;">
<span style="font-size: 0.8rem; color: #94a3b8;">åˆ†æç¶­åº¦</span>
<p class="info-text">ç¬¬ä¸€ä½æ•¸ï¼šåˆ†ææ•¸å­—çš„æœ€å·¦é‚Šä½æ•¸åˆ†ä½ˆï¼ˆä¾‹å¦‚ 123 çš„ç¬¬ä¸€ä½æ•¸ç‚º 1ï¼‰ã€‚<br>ç¬¬äºŒä½æ•¸ï¼šåˆ†ææ•¸å­—çš„ç¬¬äºŒä½æ•¸åˆ†ä½ˆï¼ˆä¾‹å¦‚ 123 çš„ç¬¬äºŒä½æ•¸ç‚º 2ï¼‰ã€‚</p>
<div class="toggle-box" onclick="setMode('first')">
<span>ç¬¬ä¸€ä½æ•¸</span>
<input type="radio" name="mode" id="modeFirst" checked>
</div>
<div class="toggle-box" onclick="setMode('second')">
<span>ç¬¬äºŒä½æ•¸</span>
<input type="radio" name="mode" id="modeSecond">
</div>
</div>

<p class="info-text" id="limitInfo">ä¸Šå‚³è³‡æ–™é™åˆ¶ï¼šåŸºæ–¼æ‚¨çš„è£ç½®æ•ˆèƒ½ï¼Œå»ºè­°ä¸Šé™ç‚º 0 ç­†ï¼ˆåµæ¸¬ä¸­...ï¼‰ã€‚</p>
<p class="info-text">åˆ†æå¹³å°å®Œå…¨åœ¨åœ°ç«¯é‹è¡Œï¼Œè³‡æ–™ä¸æœƒå¤–å‚³ï¼Œç¢ºä¿éš±ç§å®‰å…¨ã€‚</p>

<button class="btn btn-export" onclick="exportExcel()">ğŸ’¾ å°å‡ºåˆ†æçµæœ</button>
<button class="btn btn-clear" onclick="clearData()">ğŸ—‘ï¸ æ¸…é™¤è³‡æ–™ï¼Œé€²è¡Œä¸‹ä¸€ç­†</button>
</div>

<div class="main-content">
<button id="help-btn">?</button>

<div id="dashboard" style="display:none;">
<div class="stats-grid">
<div class="stat-item"><div>æ¨£æœ¬æ•¸</div><div id="statCount" class="stat-val">0</div></div>
<div class="stat-item"><div>MAD åå·®</div><div id="statMad" class="stat-val">0.0000</div></div>
<div class="stat-item"><div>é¢¨éšªè©•ä¼°</div><div id="statStatus" class="stat-val">-</div></div>
</div>
<div class="card">
<canvas id="benfordChart" height="100"></canvas>
</div>
<div class="card" style="max-height: 400px; overflow-y: auto;">
<h3>ğŸ” ç•°å¸¸æ˜ç´° (ç–‘ä¼¼æ“ç¸±æ¨™è‰²)</h3>
<table id="anomalyTable">
<thead id="tableHead"></thead>
<tbody id="tableBody"></tbody>
</table>
</div>
</div>
</div>
</div>

<div id="loading">è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>

<!-- èªªæ˜ Modal -->
<div id="helpModal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeModal()">&times;</span>
<h2>Benford Pro Max ä½¿ç”¨èªªæ˜</h2>

<h3>ä»€éº¼æ˜¯ Benford å®šå¾‹ï¼Ÿ</h3>
<p>Benford å®šå¾‹ï¼ˆç­ä½›å®šå¾‹ï¼‰æ˜¯ä¸€ç¨®æè¿°è‡ªç„¶ç”¢ç”Ÿæ•¸å­—é›†åˆä¸­ã€Œç¬¬ä¸€ä½æ•¸ã€æˆ–ã€Œç¬¬äºŒä½æ•¸ã€å‡ºç¾æ©Ÿç‡çš„æ•¸å­¸è¦å¾‹ã€‚ç°¡å–®ä¾†èªªï¼Œåœ¨è¨±å¤šçœŸå¯¦ä¸–ç•Œçš„æ•¸æ“šé›†ä¸­ï¼ˆå¦‚è²¡å‹™å ±è¡¨ã€äººå£çµ±è¨ˆã€æ²³æµé•·åº¦ç­‰ï¼‰ï¼Œæ•¸å­—ä»¥ 1 é–‹é ­çš„æ©Ÿç‡ç´„ç‚º 30.1%ï¼Œä»¥ 2 é–‹é ­ç´„ 17.6%ï¼Œä»¥æ­¤é¡æ¨ï¼Œå‘ˆç¾å°æ•¸åˆ†ä½ˆã€‚</p>
<p>ç†è«–æ©Ÿç‡è¡¨ï¼ˆç¬¬ä¸€ä½æ•¸ï¼‰ï¼š</p>
<ul>
<li>1 â†’ 30.1%</li><li>2 â†’ 17.6%</li><li>3 â†’ 12.5%</li><li>4 â†’ 9.7%</li><li>5 â†’ 7.9%</li>
<li>6 â†’ 6.7%</li><li>7 â†’ 5.8%</li><li>8 â†’ 5.1%</li><li>9 â†’ 4.6%</li>
</ul>
<p>ç•¶è³‡æ–™è¢«äººç‚ºæ“ç¸±æˆ–æé€ æ™‚ï¼Œç¬¬ä¸€ä½æ•¸çš„åˆ†ä½ˆå¾€å¾€æœƒåé›¢é€™å€‹è¦å¾‹ï¼Œæˆç‚ºåµæ¸¬è²¡å‹™èˆå¼Šã€å‡å¸³ã€ç•°å¸¸äº¤æ˜“çš„é‡è¦å·¥å…·ã€‚</p>

<h3>ç³»çµ±åŠŸèƒ½èˆ‡ä½¿ç”¨æ­¥é©Ÿ</h3>
<ol>
<li><strong>ä¸Šå‚³è³‡æ–™</strong>ï¼šæ”¯æ´ .xlsx / .xls / .csv æ ¼å¼ã€‚è‹¥ç‚ºå¤šå·¥ä½œè¡¨ Excelï¼Œæœƒå‡ºç¾å·¥ä½œè¡¨é¸æ“‡ä»‹é¢ã€‚</li>
<li><strong>é¸æ“‡å·¥ä½œè¡¨</strong>ï¼ˆè‹¥æœ‰å¤šå€‹ï¼‰â†’ é¸æ“‡è¦åˆ†æçš„æ¬„ä½ï¼ˆæ•¸å­—å‹æ¬„ä½æœ€ä½³ï¼‰ã€‚</li>
<li><strong>é¸æ“‡åˆ†æç¶­åº¦</strong>ï¼šç¬¬ä¸€ä½æ•¸ï¼ˆæœ€å¸¸ç”¨ï¼‰æˆ–ç¬¬äºŒä½æ•¸ã€‚</li>
<li>ç³»çµ±è‡ªå‹•è¨ˆç®—å¯¦éš›åˆ†ä½ˆèˆ‡ç†è«–åˆ†ä½ˆçš„ MADï¼ˆMean Absolute Deviationï¼‰åå·®ï¼š
<ul>
<li>MAD < 0.015 â†’ ä½é¢¨éšªï¼ˆç¬¦åˆè‡ªç„¶åˆ†ä½ˆï¼‰</li>
<li>MAD â‰¥ 0.015 â†’ é«˜é¢¨éšªè­¦å‘Šï¼ˆå¯èƒ½æœ‰äººç‚ºæ“ç¸±ï¼‰</li>
</ul>
</li>
<li>æŸ¥çœ‹åœ–è¡¨ã€çµ±è¨ˆæ‘˜è¦ã€ç•°å¸¸æ˜ç´°ï¼ˆå‰ 100 ç­†é«˜é¢¨éšªè³‡æ–™ï¼‰ã€‚</li>
<li><strong>å°å‡ºå ±å‘Š</strong>ï¼šåŒ…å« 5 å€‹å·¥ä½œè¡¨ï¼Œæª”åè‡ªå‹•å¸¶æ—¥æœŸæ™‚é–“ï¼ˆä¾‹å¦‚ Benford_Report_20260206_1031.xlsxï¼‰</li>
<li>é»æ“Šã€Œæ¸…é™¤è³‡æ–™ã€å¯é‡ç½®ï¼Œé€²è¡Œä¸‹ä¸€ç­†åˆ†æã€‚</li>
</ol>

<h3>æ³¨æ„äº‹é …èˆ‡é™åˆ¶</h3>
<ul>
<li>å»ºè­°å–®æ¬¡è³‡æ–™é‡ â‰¤ ${navigator.hardwareConcurrency * 10000 || 40000} ç­†ï¼ˆä¾æ‚¨çš„ CPU æ ¸å¿ƒæ•¸è‡ªå‹•ä¼°è¨ˆï¼‰ã€‚</li>
<li>è¶…éå»ºè­°ç­†æ•¸å¯èƒ½å°è‡´ç€è¦½å™¨è®Šæ…¢æˆ–ç•¶æ©Ÿï¼Œè«‹åˆ†å‰²æª”æ¡ˆå¾Œåˆ†æ‰¹åˆ†æã€‚</li>
<li>æœ¬å·¥å…·å®Œå…¨åœ¨æ‚¨çš„ç€è¦½å™¨æœ¬åœ°åŸ·è¡Œï¼Œè³‡æ–™ä¸æœƒä¸Šå‚³è‡³ä»»ä½•ä¼ºæœå™¨ï¼Œéš±ç§å®‰å…¨ã€‚</li>
<li>åƒ…é©ç”¨æ–¼æ­£æ•¸è³‡æ–™ï¼›è² æ•¸ã€å°æ•¸é»å¾Œä½æ•¸éå¤šå¯èƒ½å½±éŸ¿æº–ç¢ºæ€§ã€‚</li>
</ul>

<p style="text-align:center; margin-top:30px; color:#64748b;">
Benford Pro Max v2.0 | ç´”å‰ç«¯åœ¨åœ°ç«¯å·¥å…· | 2026
</p>
</div>
</div>

<script>
let rawData = [];
let headers = [];
let selectedCol = null;
let selectedSheet = null;
let chartInstance = null;
let analysisResult = null;
let validNumbers = [];
let anomalies = [];
let normals = [];
let wb = null;

const THEO_FIRST = [30.1, 17.6, 12.5, 9.7, 7.9, 6.7, 5.8, 5.1, 4.6];
const THEO_SECOND = [12.0, 11.4, 10.9, 10.4, 10.0, 9.7, 9.3, 9.0, 8.8, 8.5];

// æ•ˆèƒ½ä¼°è¨ˆ
const cpuCores = navigator.hardwareConcurrency || 4;
const dataLimit = Math.max(10000, cpuCores * 10000);
document.getElementById('limitInfo').innerText = 
`ä¸Šå‚³è³‡æ–™é™åˆ¶ï¼šåŸºæ–¼æ‚¨çš„è£ç½®æ•ˆèƒ½ï¼Œå»ºè­°ä¸Šé™ç‚º ${dataLimit} ç­†ï¼ˆåµæ¸¬åˆ° ${cpuCores} æ ¸å¿ƒ CPUï¼‰ã€‚è¶…éå¯èƒ½å°è‡´ç€è¦½å™¨å¡é “ã€‚`;

function showLoading(show) {
document.getElementById('loading').style.display = show ? 'block' : 'none';
}

function generateTestData() {
showLoading(true);
const testData = [];
for(let i = 0; i < 1000; i++) {
const natural = Math.pow(10, Math.random() * 5).toFixed(2);
const manipulated = Math.floor(Math.random() * 9000) + 1000;
testData.push({ "äº¤æ˜“ID": i+1, "è‡ªç„¶æ•¸æ“š(ç¬¦åˆ)": natural, "äººç‚ºæ•¸æ“š(ç•°å¸¸)": manipulated });
}
wb = null;
handleNewData(testData, ['TestSheet']);
showLoading(false);
}

document.getElementById('fileInput').addEventListener('change', function(e) {
showLoading(true);
const file = e.target.files[0];
const reader = new FileReader();
reader.onload = function(evt) {
wb = XLSX.read(evt.target.result, {type: 'array'});
const sheetNames = wb.SheetNames;
handleNewData([], sheetNames);
showLoading(false);
};
reader.readAsArrayBuffer(file);
});

function handleNewData(data, sheetNames) {
document.getElementById('dashboard').style.display = 'block';
document.getElementById('sheetSection').style.display = sheetNames.length > 1 ? 'block' : 'none';
document.getElementById('colSection').style.display = 'none';

const sheetList = document.getElementById('sheetList');
sheetList.innerHTML = '';
sheetNames.forEach(sh => {
const s = document.createElement('div');
s.className = 'tag'; s.innerText = sh;
s.onclick = () => { 
document.querySelectorAll('#sheetList .tag').forEach(t => t.classList.remove('active'));
s.classList.add('active'); 
selectedSheet = sh;
rawData = XLSX.utils.sheet_to_json(wb ? wb.Sheets[sh] : null, {defval: ""});
if (rawData.length > dataLimit) {
alert(`è³‡æ–™ç­†æ•¸ (${rawData.length}) è¶…éå»ºè­°ä¸Šé™ (${dataLimit})ï¼Œå¯èƒ½å½±éŸ¿æ•ˆèƒ½ã€‚å»ºè­°åˆ†å‰²æª”æ¡ˆã€‚`);
}
headers = Object.keys(rawData[0] || {});
const colList = document.getElementById('columnList');
colList.innerHTML = '';
headers.forEach(h => {
const c = document.createElement('div');
c.className = 'tag'; c.innerText = h;
c.onclick = () => { 
document.querySelectorAll('#columnList .tag').forEach(t => t.classList.remove('active'));
c.classList.add('active'); selectedCol = h; run();
};
colList.appendChild(c);
});
document.getElementById('colSection').style.display = 'block';
};
sheetList.appendChild(s);
});

if (sheetNames.length === 1) {
selectedSheet = sheetNames[0];
rawData = data.length ? data : XLSX.utils.sheet_to_json(wb ? wb.Sheets[selectedSheet] : null, {defval: ""});
headers = Object.keys(rawData[0] || {});
document.getElementById('colSection').style.display = 'block';
const colList = document.getElementById('columnList');
colList.innerHTML = '';
headers.forEach(h => {
const c = document.createElement('div');
c.className = 'tag'; c.innerText = h;
c.onclick = () => { 
document.querySelectorAll('#columnList .tag').forEach(t => t.classList.remove('active'));
c.classList.add('active'); selectedCol = h; run();
};
colList.appendChild(c);
});
}
}

function setMode(m) {
document.getElementById('modeFirst').checked = (m === 'first');
document.getElementById('modeSecond').checked = (m === 'second');
if (selectedCol) run();
}

function run() {
if (!selectedCol || rawData.length === 0) {
alert('è«‹é¸æ“‡æ¬„ä½æˆ–ä¸Šå‚³è³‡æ–™');
return;
}

showLoading(true);
const isSecond = document.getElementById('modeSecond').checked;
const counts = new Array(isSecond ? 10 : 9).fill(0);
let valid = 0;
validNumbers = [];
anomalies = [];
normals = [];
const digitRegex = /[1-9]/g;

rawData.forEach((row, index) => {
const val = row[selectedCol];
if (typeof val !== 'number' && typeof val !== 'string') return;
const s = val.toString().replace(/[^0-9.]/g, '');
const matches = s.match(digitRegex);
if (!matches) {
normals.push(row);
return;
}

let digit;
const firstDigit = parseInt(matches[0]);
if (isSecond && matches[1]) {
digit = parseInt(matches[1]);
} else {
digit = firstDigit;
}

if (!isNaN(digit)) {
const idx = isSecond ? digit : digit - 1;
if (counts[idx] !== undefined) {
counts[idx]++;
valid++;
const entry = { digit: digit, row: row, index: index };
validNumbers.push(entry);
}
}
});

if (valid === 0) {
alert('é¸å®šæ¬„ä½ç„¡æœ‰æ•ˆæ•¸å­—ï¼Œè«‹æª¢æŸ¥è³‡æ–™');
showLoading(false);
return;
}

const actual = counts.map(c => (c / valid * 100));
const theo = isSecond ? THEO_SECOND : THEO_FIRST;
const mad = actual.reduce((acc, p, i) => acc + Math.abs(p / 100 - theo[i] / 100), 0) / theo.length;

analysisResult = { actual, theo, mad, valid };

validNumbers.forEach(n => {
const dev = Math.abs(actual[isSecond ? n.digit : n.digit - 1] - theo[isSecond ? n.digit : n.digit - 1]);
if (dev > 2 || (!isSecond && n.digit >= 7)) {
anomalies.push(n.row);
} else {
normals.push(n.row);
}
});

updateUI(valid, mad, actual, theo, isSecond, validNumbers);
showLoading(false);
}

function updateUI(count, mad, actual, theo, isSecond, validNumbers) {
document.getElementById('statCount').innerText = count;
document.getElementById('statMad').innerText = mad.toFixed(4);
const status = document.getElementById('statStatus');
status.innerText = mad < 0.015 ? "ä½é¢¨éšª" : "é«˜é¢¨éšªè­¦å‘Š";
status.style.color = mad < 0.015 ? "var(--success)" : "var(--danger)";

if (chartInstance) chartInstance.destroy();
chartInstance = new Chart(document.getElementById('benfordChart'), {
type: 'bar',
data: {
labels: isSecond ? [0,1,2,3,4,5,6,7,8,9] : [1,2,3,4,5,6,7,8,9],
datasets: [
{ label: 'å¯¦éš›åˆ†ä½ˆ %', data: actual, backgroundColor: '#2563eb' },
{ label: 'ç†è«–åˆ†ä½ˆ %', data: theo, type: 'line', borderColor: '#ef4444' }
]
},
options: { responsive: true }
});

const head = document.getElementById('tableHead');
head.innerHTML = `<tr>${headers.slice(0, 5).map(h => `<th>${h}</th>`).join('')}</tr>`;
const body = document.getElementById('tableBody');
body.innerHTML = '';
const filteredAnomalies = validNumbers.filter(n => {
const dev = Math.abs(actual[isSecond ? n.digit : n.digit - 1] - theo[isSecond ? n.digit : n.digit - 1]);
return dev > 2 || (!isSecond && n.digit >= 7);
});
filteredAnomalies.slice(0, 100).forEach(n => {
const tr = document.createElement('tr');
tr.className = 'high-risk';
headers.slice(0, 5).forEach(h => {
const td = document.createElement('td');
td.innerText = n.row[h];
tr.appendChild(td);
});
body.appendChild(tr);
});
}

function exportExcel() {
if (!analysisResult) {
alert('è«‹å…ˆåŸ·è¡Œåˆ†æ');
return;
}

const isSecond = document.getElementById('modeSecond').checked;

// ç”¢ç”Ÿæ—¥æœŸæ™‚é–“æˆ³
const now = new Date();
const year = now.getFullYear();
const month = String(now.getMonth() + 1).padStart(2, '0');
const day = String(now.getDate()).padStart(2, '0');
const hour = String(now.getHours()).padStart(2, '0');
const minute = String(now.getMinutes()).padStart(2, '0');
const timestamp = `${year}${month}${day}_${hour}${minute}`;
const filename = `Benford_Report_${timestamp}.xlsx`;

const summaryData = [
{ 'é …ç›®': 'åˆ†æç¶­åº¦', 'å€¼': isSecond ? 'ç¬¬äºŒä½æ•¸' : 'ç¬¬ä¸€ä½æ•¸' },
{ 'é …ç›®': 'æ¨£æœ¬æ•¸', 'å€¼': analysisResult.valid },
{ 'é …ç›®': 'MAD åå·®', 'å€¼': analysisResult.mad.toFixed(4) },
{ 'é …ç›®': 'é¢¨éšªè©•ä¼°', 'å€¼': analysisResult.mad < 0.015 ? 'ä½é¢¨éšª' : 'é«˜é¢¨éšªè­¦å‘Š' },
{ 'é …ç›®': 'åˆ†ææ™‚é–“', 'å€¼': now.toLocaleString('zh-TW') }
];

const distData = analysisResult.actual.map((a, i) => ({
'æ•¸å­—': i + (isSecond ? 0 : 1),
'å¯¦éš› %': a.toFixed(2),
'ç†è«– %': analysisResult.theo[i]
}));

const exportWb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(exportWb, XLSX.utils.json_to_sheet(summaryData), "æ‘˜è¦é ");
XLSX.utils.book_append_sheet(exportWb, XLSX.utils.json_to_sheet(distData), "åœ–è¡¨é ");
XLSX.utils.book_append_sheet(exportWb, XLSX.utils.json_to_sheet(rawData), "åŸå§‹è³‡æ–™");
XLSX.utils.book_append_sheet(exportWb, XLSX.utils.json_to_sheet(anomalies), "ç•°å¸¸è³‡æ–™");
XLSX.utils.book_append_sheet(exportWb, XLSX.utils.json_to_sheet(normals), "æ­£å¸¸è³‡æ–™");

XLSX.writeFile(exportWb, filename);
}

function clearData() {
rawData = [];
headers = [];
selectedCol = null;
selectedSheet = null;
analysisResult = null;
validNumbers = [];
anomalies = [];
normals = [];
wb = null;
if (chartInstance) chartInstance.destroy();
chartInstance = null;
document.getElementById('dashboard').style.display = 'none';
document.getElementById('sheetSection').style.display = 'none';
document.getElementById('colSection').style.display = 'none';
document.getElementById('statCount').innerText = '0';
document.getElementById('statMad').innerText = '0.0000';
document.getElementById('statStatus').innerText = '-';
document.getElementById('tableBody').innerHTML = '';
document.getElementById('sheetList').innerHTML = '';
document.getElementById('columnList').innerHTML = '';
alert('è³‡æ–™å·²æ¸…é™¤ï¼Œæº–å‚™é€²è¡Œä¸‹ä¸€ç­†åˆ†æã€‚');
}

// èªªæ˜ Modal æ§åˆ¶
document.getElementById('help-btn').onclick = function() {
document.getElementById('helpModal').style.display = "block";
};

function closeModal() {
document.getElementById('helpModal').style.display = "none";
}

window.onclick = function(event) {
const modal = document.getElementById('helpModal');
if (event.target === modal) {
modal.style.display = "none";
}
};
</script>
</body>
</html>
